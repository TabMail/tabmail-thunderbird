<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TabMail Prompts</title>
  <link rel="stylesheet" href="prompts.css" />
</head>
<body>
  <div id="page">
    <header>
      <h2>TabMail Prompts</h2>
      <p class="header-description">Manage your email composition settings and action classification rules</p>
    </header>

    <section id="prompt-selector">
      <div class="prompt-tabs">
        <button class="prompt-tab active" data-prompt="composition">Email Composition</button>
        <button class="prompt-tab" data-prompt="action">Action Classification</button>
        <button class="prompt-tab" data-prompt="kb">Knowledge Base</button>
        <button class="prompt-tab" data-prompt="reminders">Reminders</button>
        <button class="prompt-tab" data-prompt="history">Chat History</button>
        <button class="prompt-tab dev-only" data-prompt="developer" style="display: none;">Developer (Raw)</button>
      </div>
    </section>

    <div id="composition-editor" class="prompt-content active">
      <div id="composition-sections"></div>
    </div>

    <div id="action-editor" class="prompt-content">
      <div id="action-sections"></div>
    </div>

    <div id="kb-editor" class="prompt-content">
      <div class="section-container">
        <div class="section-header">
          <h3>Knowledge Base Configuration</h3>
        </div>
        <div class="kb-config-content">
          <div class="kb-config-row">
            <label for="kb-reminder-retention">Reminder retention (days):</label>
            <div class="kb-slider-group">
              <input type="range" id="kb-reminder-retention" min="1" max="90" step="1" value="14" />
              <span class="kb-slider-value" id="kb-reminder-retention-val">14</span>
            </div>
            <span class="kb-config-hint">Reminders past due by more than this are automatically removed</span>
          </div>
          <div class="kb-config-row">
            <label for="kb-max-bullets">Max Knowledge Base entries:</label>
            <div class="kb-slider-group">
              <input type="range" id="kb-max-bullets" min="10" max="500" step="10" value="100" />
              <span class="kb-slider-value" id="kb-max-bullets-val">100</span>
            </div>
            <span class="kb-config-hint">Excludes reminders. KB trimmed if over limit (higher = more context)</span>
          </div>
        </div>
      </div>
      <div class="section-container">
        <div class="section-header">
          <h3>Personal Knowledge Base <span id="kb-entry-count" class="kb-entry-count"></span></h3>
          <div class="section-header-actions">
            <div class="kb-compress-group">
              <span id="compress-kb-spinner" class="kb-spinner" style="display: none;"></span>
              <button id="compress-kb" class="reload-section-btn">Compress</button>
            </div>
            <button id="save-kb" class="save-section-btn">Save</button>
            <button id="reload-kb" class="reload-section-btn">Reload</button>
            <button id="reset-kb" class="reset-section-btn">Reset</button>
          </div>
        </div>
        <div class="kb-section-note">
          <p>Stores <strong>behavioral directives</strong> (how the agent should act) and <strong>preemptive knowledge</strong> (facts needed before being asked). Searchable content is retrieved on demand via Chat History Search. Prefix with <code>[Pinned]</code> to protect from automatic cleanup.</p>
        </div>
        <div class="simple-content">
          <textarea id="kb-content" placeholder="Add behavioral directives (e.g., 'Always CC my assistant on replies to the VP') and preemptive knowledge (e.g., Zoom links, PTO schedules)..."></textarea>
        </div>
      </div>
    </div>

    <div id="developer-editor" class="prompt-content">
      <div class="dev-test-section">
        <div class="dev-test-header">
          <h3>Backend Tests</h3>
        </div>
        <div class="dev-test-content">
          <div class="dev-test-row">
            <button id="test-kb-refine" class="test-btn">Test KB Refinement</button>
            <span class="dev-test-hint">Tests the full KB orchestration pipeline with fake data</span>
          </div>
          <div id="test-kb-refine-output" class="dev-test-output" style="display: none;">
            <div class="dev-test-output-header">
              <span>Output</span>
              <button id="clear-test-output" class="clear-btn">Clear</button>
            </div>
            <pre id="test-kb-refine-result"></pre>
          </div>
        </div>
      </div>

      <div class="dev-prompt-container">
        <div class="dev-prompt-section">
          <div class="dev-prompt-header">
            <h3>user_composition.md</h3>
            <div class="dev-prompt-actions">
              <button id="save-raw-composition" class="save-section-btn">Save</button>
              <button id="reload-raw-composition" class="reload-section-btn">Reload</button>
              <button id="reset-raw-composition" class="reset-section-btn">Reset</button>
            </div>
          </div>
          <textarea id="raw-composition-content" class="dev-prompt-textarea" spellcheck="false"></textarea>
        </div>
        
        <div class="dev-prompt-section">
          <div class="dev-prompt-header">
            <h3>user_action.md</h3>
            <div class="dev-prompt-actions">
              <button id="save-raw-action" class="save-section-btn">Save</button>
              <button id="reload-raw-action" class="reload-section-btn">Reload</button>
              <button id="reset-raw-action" class="reset-section-btn">Reset</button>
            </div>
          </div>
          <textarea id="raw-action-content" class="dev-prompt-textarea" spellcheck="false"></textarea>
        </div>
        
        <div class="dev-prompt-section">
          <div class="dev-prompt-header">
            <h3>user_kb.md</h3>
            <div class="dev-prompt-actions">
              <button id="save-raw-kb" class="save-section-btn">Save</button>
              <button id="reload-raw-kb" class="reload-section-btn">Reload</button>
              <button id="reset-raw-kb" class="reset-section-btn">Reset</button>
            </div>
          </div>
          <textarea id="raw-kb-content" class="dev-prompt-textarea" spellcheck="false"></textarea>
        </div>
      </div>
    </div>

    <div id="reminders-editor" class="prompt-content">
      <div class="section-container">
        <div class="section-header">
          <h3>Reminders</h3>
          <div class="section-header-actions">
            <button id="refresh-reminders" class="reload-section-btn">Refresh</button>
          </div>
        </div>
        <div class="reminders-content">
          <p class="reminders-description">
            Manage which reminders appear in your chat window. Disabled reminders won't be shown when you open the chat.
          </p>
          <div id="reminders-list">
            <div class="reminders-loading">Loading reminders...</div>
          </div>
          <p id="reminders-empty" class="reminders-empty" style="display: none;">
            No reminders found. Reminders are generated from your inbox messages and knowledge base.
          </p>
        </div>
      </div>
    </div>

    <div id="history-editor" class="prompt-content">
      <div class="section-container">
        <div class="section-header">
          <h3>Chat History</h3>
          <div class="section-header-actions">
            <button id="refresh-history" class="reload-section-btn">Refresh</button>
            <button id="delete-old-history" class="reload-section-btn">Delete Old…</button>
            <button id="clear-history" class="reset-section-btn">Clear All</button>
          </div>
        </div>
        <div class="history-content">
          <div class="history-stats" id="history-stats">
            <span class="history-stat">Loading...</span>
          </div>
          <div class="history-search-bar">
            <input type="text" id="history-search-input" placeholder="Search chat history…" />
            <button id="history-search-btn" class="reload-section-btn">Search</button>
          </div>
          <div id="history-list">
            <div class="history-loading">Loading chat history...</div>
          </div>
          <div id="history-pagination" class="history-pagination" style="display: none;">
            <button id="history-prev-page" class="pagination-btn" disabled>← Previous</button>
            <span id="history-page-info" class="pagination-info">Page 1 of 1</span>
            <button id="history-next-page" class="pagination-btn" disabled>Next →</button>
          </div>
          <p id="history-empty" class="history-empty" style="display: none;">
            No chat history stored. Chat sessions are saved when you close or renew a chat.
          </p>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal Overlay -->
    <div id="history-modal-overlay" class="modal-overlay" style="display: none;">
      <div class="modal-dialog">
        <h3 id="modal-title">Confirm Action</h3>
        <div id="modal-content"></div>
        <div class="modal-actions">
          <button id="modal-cancel" class="reload-section-btn">Cancel</button>
          <button id="modal-confirm" class="reset-section-btn">Confirm</button>
        </div>
      </div>
    </div>

    <div id="action-buttons">
      <button id="save-changes" class="primary-button">Save Entire Prompt</button>
      <button id="reload-prompts">Reload Entire Prompt</button>
      <button id="reset-prompt" class="danger-button">Reset Entire Prompt</button>
      <div id="status-message"></div>
    </div>
  </div>

  <script type="module" src="prompts.js"></script>
</body>
</html>

